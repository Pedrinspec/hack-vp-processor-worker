services:
  # ---------------------------------------------------------------------------
  # vp-processor-worker — Aplicação principal
  # ---------------------------------------------------------------------------
  vp-processor-worker:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    container_name: vp-processor-worker
    environment:
      # Redis
      REDIS_HOST: ${REDIS_HOST:-localhost}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_TIMEOUT: ${REDIS_TIMEOUT:-60000}

      # AWS S3
      AWS_REGION: ${AWS_REGION:-sa-east-1}
      ACCESS_KEY: ${ACCESS_KEY}
      ACCESS_SECRET: ${ACCESS_SECRET}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:-}
      S3_VIDEO_BUCKET: ${S3_VIDEO_BUCKET:-hack-vp-videos}

      # Kafka
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      VIDEO_PROCESSOR_TOPIC: ${VIDEO_PROCESSOR_TOPIC:-video-processor-topic}
      VIDEO_PROCESSOR_GROUP_ID: ${VIDEO_PROCESSOR_GROUP_ID:-video-processor}
      AUTO_OFFSET_RESET_CONFIG: ${AUTO_OFFSET_RESET_CONFIG:-earliest}

      # FFmpeg
      FFMPEG_PATH: /usr/bin/ffmpeg

      # JVM
      JAVA_OPTS: ${JAVA_OPTS:--XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0}
    restart: on-failure:3
    networks:
      - vp-network
# =============================================================================
# Rede interna isolada
# =============================================================================
networks:
  vp-network:
    external: true
